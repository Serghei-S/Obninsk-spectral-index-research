# 🧪 ТЕСТ ML ПРОГНОЗА - Пошаговая инструкция

## ✅ Статус системы:

- **Backend:** ✅ Работает на http://localhost:8000
- **Frontend:** ✅ Работает на http://localhost:3000
- **ML Endpoint:** ✅ `/api/v1/forecast/indices` зарегистрирован
- **Контейнеры:** ✅ Пересобраны и перезапущены

---

## 📋 БЫСТРЫЙ ТЕСТ (5 минут):

### Шаг 1: Откройте приложение
```
http://localhost:3000
```

### Шаг 2: Войдите в систему
Используйте существующий аккаунт или зарегистрируйтесь

### Шаг 3: Откройте карту
- Нажмите **🗺️ Карта** в верхнем меню

### Шаг 4: Нарисуйте полигон
1. Найдите на карте сельскохозяйственное поле (можно в России, например Калужская область)
2. Используйте инструмент рисования (квадрат/полигон в левом верхнем углу)
3. Нарисуйте полигон (5-10 точек)
4. Нажмите **"Finish"** для завершения

### Шаг 5: Откройте "Анализ динамики"
1. Кликните по нарисованному полигону
2. В popup окне нажмите **"📈 Анализ динамики"**

### Шаг 6: Настройте параметры
- **Дата начала:** `2025-07-01` (3 месяца назад)
- **Дата окончания:** `2025-10-18` (сегодня)  
- **Индекс:** Оставьте только **NDVI** (галочка)

### Шаг 7: Загрузите данные
- Нажмите **"Анализировать динамику"**
- Подождите 10-20 секунд
- Вы увидите график временного ряда

### Шаг 8: НАЙДИТЕ БЛОК ML ПРОГНОЗА! ⬇️

**После загрузки графика, под кнопкой "Анализировать динамику" должен появиться новый блок:**

```
┌─────────────────────────────────────────────┐
│ 🟣 Фиолетовый блок с рамкой                │
│                                             │
│ Горизонт прогноза (дней): [30]  [🤖 ML Прогноз (NDVI)] │
└─────────────────────────────────────────────┘
```

**Если НЕ видите этот блок - обновите страницу:**
- Нажмите `Ctrl + F5` (жесткое обновление с очисткой кеша)
- Или `Ctrl + Shift + R`

### Шаг 9: Запустите прогноз
1. Оставьте значение **30** дней
2. Нажмите **"🤖 ML Прогноз (NDVI)"**
3. Подождите 3-5 секунд

### Шаг 10: Проверьте результат

График должен обновиться и показать:
- 🟢 **Зеленые круглые точки** (●) - исторические данные Sentinel-2
- 🟡 **Серые крестики** (✕) с пунктиром - интерполированные точки
- 🟣 **Фиолетовые квадраты** (■) с пунктиром - прогноз ML на 30 дней

**Должен появиться зеленый инфо-блок:**
```
✅ Прогноз сгенерирован: NDVI на 30 дней
Модель: GradientBoostingRegressor (Seasonal Features)
[Вернуться к исходным данным]
```

---

## 🔍 ЧТО ПРОВЕРИТЬ:

### ✅ Визуальные элементы:
- [ ] Фиолетовый блок с полем ввода и кнопкой появился после загрузки графика
- [ ] Кнопка называется **"🤖 ML Прогноз (NDVI)"**
- [ ] После клика на кнопку появляется "Генерация прогноза..." со спиннером
- [ ] График обновляется с тремя типами данных
- [ ] Появляется зеленый инфо-блок с результатами

### ✅ График:
- [ ] **Легенда** вверху графика показывает 3 dataset'а
- [ ] Цвета правильные (зеленый/серый/фиолетовый)
- [ ] Прогноз логично продолжает тренд
- [ ] Нет резких скачков на границе история/прогноз

---

## ❌ ЕСЛИ НЕ ВИДИТЕ БЛОК ML ПРОГНОЗА:

### Проблема 1: Старый кеш браузера
**Решение:**
```
1. Нажмите Ctrl + F5 (жесткое обновление)
2. Или откройте в режиме инкогнито: Ctrl + Shift + N
3. Или очистите кеш: Ctrl + Shift + Delete → выберите "Изображения и файлы" → "За все время"
```

### Проблема 2: Frontend не пересобрался
**Решение:**
```powershell
# Перезапустите frontend
docker-compose restart frontend

# Подождите 10 секунд
Start-Sleep -Seconds 10

# Обновите браузер с Ctrl + F5
```

### Проблема 3: JavaScript ошибка
**Решение:**
```
1. Откройте DevTools (F12)
2. Перейдите на вкладку "Console"
3. Обновите страницу (F5)
4. Проверьте наличие красных ошибок
5. Скопируйте текст ошибки если есть
```

---

## 🌐 АЛЬТЕРНАТИВНЫЙ ТЕСТ (через API напрямую):

### Откройте FastAPI документацию:
```
http://localhost:8000/docs
```

### Найдите секцию "ML Forecast":
- Эндпоинт: `POST /api/v1/forecast/indices`

### Нажмите "Try it out" и вставьте:
```json
{
  "index_name": "NDVI",
  "historical_data": [
    {"date": "2025-07-01", "value": 0.45},
    {"date": "2025-07-10", "value": 0.52},
    {"date": "2025-07-20", "value": 0.58},
    {"date": "2025-07-30", "value": 0.62},
    {"date": "2025-08-10", "value": 0.68},
    {"date": "2025-08-20", "value": 0.72},
    {"date": "2025-08-30", "value": 0.75},
    {"date": "2025-09-10", "value": 0.71},
    {"date": "2025-09-20", "value": 0.68},
    {"date": "2025-09-30", "value": 0.64},
    {"date": "2025-10-10", "value": 0.58}
  ],
  "forecast_horizon_days": 30
}
```

### Нажмите "Execute"

### Проверьте ответ:
- **Status:** 200 OK
- **Response:** JSON с forecast массивом, содержащим точки типа Historical/Interpolated/Forecast

---

## 📸 Как должно выглядеть (контрольные точки):

### 1. После "Анализировать динамику" (КЛЮЧЕВОЙ МОМЕНТ!):
```
┌────────────────────────────────────────────┐
│ [✓ NDVI] [ ] EVI [ ] PSRI...              │
│                                            │
│ Дата начала: [2025-07-01]                 │
│ Дата окончания: [2025-10-18]              │
│                                            │
│ [Анализировать динамику]                  │
│                                            │
│ ┌────────────────────────────────────┐    │ ⬅️ ЭТОТ БЛОК!
│ │🟣 Горизонт прогноза (дней): [30]  │    │
│ │                                    │    │
│ │ [🤖 ML Прогноз (NDVI)]             │    │
│ └────────────────────────────────────┘    │
└────────────────────────────────────────────┘
```

### 2. После нажатия "🤖 ML Прогноз":
```
┌────────────────────────────────────────────┐
│ ┌────────────────────────────────────┐    │
│ │ 🔄 Генерация прогноза...          │    │ ⬅️ Загрузка
│ └────────────────────────────────────┘    │
└────────────────────────────────────────────┘
```

### 3. После успешного прогноза:
```
┌────────────────────────────────────────────┐
│ ┌────────────────────────────────────┐    │
│ │✅ Прогноз сгенерирован: NDVI на 30 │    │
│ │дней                                │    │
│ │Модель: GradientBoostingRegressor...│    │
│ │                                    │    │
│ │ [Вернуться к исходным данным]     │    │
│ └────────────────────────────────────┘    │
│                                            │
│ [График с 3 типами данных]                │
│ ● Зеленые - Historical                    │
│ ✕ Серые - Interpolated                    │
│ ■ Фиолетовые - Forecast                   │
└────────────────────────────────────────────┘
```

---

## 🐛 Отладка через DevTools:

### Откройте консоль (F12):
1. Перейдите на вкладку **Console**
2. Обновите страницу (F5)
3. Откройте "Анализ динамики"
4. Загрузите данные
5. **Ищите в консоли:**
   - `handleGenerateForecast` - функция прогноза
   - `forecastTimeSeries` - вызов API
   - Ошибки красным цветом (если есть)

### Проверьте Network (F12 → Network):
1. Загрузите данные временного ряда
2. Нажмите "🤖 ML Прогноз"
3. **Должен появиться запрос:**
   - URL: `http://localhost:8000/api/v1/forecast/indices`
   - Method: `POST`
   - Status: `200 OK`
4. Кликните на запрос → **Preview** → проверьте JSON ответ

---

## ✅ КОНТРОЛЬНЫЙ СПИСОК:

- [ ] Backend работает (http://localhost:8000)
- [ ] Frontend работает (http://localhost:3000)
- [ ] Вошли в систему
- [ ] Нарисовали полигон на карте
- [ ] Открыли "Анализ динамики"
- [ ] Настроили даты (3 месяца)
- [ ] Загрузили график NDVI
- [ ] **ВИДИТЕ фиолетовый блок с input и кнопкой "🤖 ML Прогноз"**
- [ ] Нажали кнопку прогноза
- [ ] График обновился с 3 типами данных
- [ ] Появился зеленый инфо-блок с метаданными

---

## 📞 Если проблема сохраняется:

1. Проверьте логи backend:
   ```powershell
   docker logs agrosky-backend --tail 50
   ```

2. Проверьте логи frontend:
   ```powershell
   docker logs agrosky-frontend --tail 50
   ```

3. Проверьте DevTools Console (F12):
   - Есть ли красные ошибки?
   - Что пишет при загрузке страницы?

4. Сделайте скриншот того, что видите после загрузки графика

---

## 🎯 ГЛАВНОЕ:

**Фиолетовый блок с кнопкой "🤖 ML Прогноз (NDVI)" должен появиться СРАЗУ после успешной загрузки графика временного ряда!**

Если его НЕТ - обновите страницу с `Ctrl + F5` и попробуйте снова!

