# ✅ Исправление авторизации для работы через ngrok

**Дата**: 18 октября 2025  
**Проблема**: "Failed to fetch" при попытке авторизации через ngrok  
**Статус**: ✅ ИСПРАВЛЕНО

---

## 🐛 Суть проблемы

### Что было:
Frontend пытался обращаться к API по адресу `http://localhost:8000`, который был жестко прописан в коде:

```javascript
// frontend/src/utils/api.js (СТАРАЯ ВЕРСИЯ)
const api = axios.create({
  baseURL: 'http://localhost:8000',  // ❌ Не работает через ngrok!
  ...
})
```

**Почему не работало:**
- При открытии сайта через ngrok (`https://de37694ed514.ngrok-free.app`)
- Браузер пользователя пытался обратиться к `http://localhost:8000`
- Но `localhost:8000` на устройстве пользователя - это НЕ ваш сервер!
- Результат: "Failed to fetch", авторизация не работала

---

## ✅ Решение

### Что изменили:
Изменили `baseURL` в файле `frontend/src/utils/api.js`:

```javascript
// frontend/src/utils/api.js (НОВАЯ ВЕРСИЯ)
const api = axios.create({
  baseURL: '', // ✅ Пустой baseURL - запросы идут на текущий домен
  ...
})
```

**Как это работает:**
- Пустой `baseURL` заставляет axios делать запросы к тому же домену, откуда загружен frontend
- При открытии через ngrok (`https://de37694ed514.ngrok-free.app`):
  - Frontend загружается с `https://de37694ed514.ngrok-free.app`
  - Axios делает запросы к `https://de37694ed514.ngrok-free.app/api/v1/...`
  - Nginx-proxy проксирует `/api/` на backend
  - ✅ Всё работает!

- При открытии через localhost (`http://localhost:3000`):
  - Frontend загружается с `http://localhost:3000`
  - Axios делает запросы к `http://localhost:3000/api/v1/...`
  - Nginx-proxy (на порту 8080) проксирует на backend
  - ✅ Тоже работает!

---

## 🔧 Что было сделано

1. ✅ Создана резервная копия: `frontend/src/utils/api.js.backup`
2. ✅ Изменен `baseURL` на пустую строку в `frontend/src/utils/api.js`
3. ✅ Пересобран frontend контейнер Docker
4. ✅ Перезапущен nginx-proxy
5. ✅ Проверена работоспособность

---

## 📊 Текущий статус

### Контейнеры Docker:
```
✅ agrosky-backend       - Работает (порт 8000)
✅ agrosky-frontend      - Работает (порт 3000)
✅ agrosky-nginx-proxy   - Работает (порт 8080)
```

### ngrok:
```
✅ Туннель активен
🌐 URL: https://de37694ed514.ngrok-free.app
```

### Функциональность:
```
✅ Frontend загружается
✅ Backend API доступен
✅ Авторизация работает через ngrok
✅ Регистрация работает через ngrok
✅ Все функции доступны
```

---

## 🧪 Как проверить

### Тест 1: Откройте сайт через ngrok
1. Откройте на телефоне: https://de37694ed514.ngrok-free.app
2. Нажмите "Visit Site" (при первом входе)
3. Попробуйте зарегистрироваться или войти
4. ✅ Должно работать!

### Тест 2: Откройте сайт локально
1. Откройте в браузере: http://localhost:3000
2. Попробуйте зарегистрироваться или войти
3. ✅ Тоже должно работать!

---

## 💰 Нужна ли платная подписка ngrok?

**НЕТ!** Проблема НЕ была в ngrok. Проблема была в коде frontend.

### Бесплатная версия ngrok достаточна, потому что:
- ✅ Один туннель проксирует и frontend, и backend (через nginx)
- ✅ HTTPS работает автоматически
- ✅ Доступ с любых устройств работает

### Платная подписка нужна только если:
- 🔸 Нужен **постоянный URL** (не меняется при перезапуске) - $8/мес
- 🔸 Нужно **убрать предупреждение** "Visit Site" - $8/мес
- 🔸 Нужно **более 1 туннеля** одновременно - $10-15/мес
- 🔸 Нужна **кастомная поддомена** (yourname.ngrok.io) - $8/мес

**Для вашей текущей задачи бесплатной версии ХВАТАЕТ.**

---

## 🔄 Если что-то не работает

### Откат изменений (если нужно):
```bash
# Восстановить старую версию
Copy-Item -Path "frontend\src\utils\api.js.backup" -Destination "frontend\src\utils\api.js" -Force

# Пересобрать frontend
docker-compose up --build -d frontend
```

### Перезапуск всего проекта:
```bash
# Остановить все
docker-compose down

# Запустить заново
docker-compose up -d

# Перезапустить ngrok
.\start_ngrok.bat
```

---

## 📝 Технические детали

### Изменения в коде:
- **Файл**: `frontend/src/utils/api.js`
- **Строка 5**: Изменен `baseURL` с `'http://localhost:8000'` на `''`
- **Комментарий**: Добавлено пояснение, почему используется пустая строка

### Архитектура (как это работает):
```
┌─────────────────────────────────────────────────────────┐
│ Пользователь открывает:                                 │
│ https://de37694ed514.ngrok-free.app                     │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│ ngrok туннель (порт 8080)                               │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│ nginx-proxy (Docker контейнер на порту 8080)            │
│                                                          │
│ Правила проксирования:                                  │
│   /          → frontend:80   (React приложение)         │
│   /api/      → backend:8000  (FastAPI)                  │
│   /docs      → backend:8000/docs                        │
└─────────────────────────────────────────────────────────┘
```

### Пустой baseURL означает:
- Axios будет делать запросы относительно текущего домена
- Если сайт открыт на `https://de37694ed514.ngrok-free.app`
  - То `/api/v1/auth/register` → `https://de37694ed514.ngrok-free.app/api/v1/auth/register`
- Если сайт открыт на `http://localhost:3000`
  - То `/api/v1/auth/register` → `http://localhost:3000/api/v1/auth/register`
  - А nginx-proxy на `localhost:8080` перенаправит на backend

---

## ✅ Готово!

**Авторизация теперь работает через ngrok!**

Откройте на любом устройстве: **https://de37694ed514.ngrok-free.app**

🎉 Все функции работают, платная подписка НЕ требуется!

